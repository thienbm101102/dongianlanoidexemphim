<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đơn Giản Là Web Xem Phim</title>
    <link rel="stylesheet" href="styles.css?v=999999">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="https://media.discordapp.net/attachments/1418490592320819235/1476650043426476052/IMG_4464.png?ex=69a1e505&is=69a09385&hm=c43389c4363f9710bfe4249a14cfaa6c7187a741c6c9be796f73c7e91728c9d8&=&format=webp&quality=lossless&width=1271&height=715">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
	
    <style>
        .keyword-tag {
            background: rgba(255,255,255,0.05);
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: 0.3s;
            display: inline-block;
            margin-right: 8px;
            margin-bottom: 10px;
            color: #ddd;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .keyword-tag:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 77, 77, 0.3);
        }
        /* Style cho nút chọn Server Lồng Tiếng / Vietsub */
        .server-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 6px 15px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
        }
        .server-btn.active, .server-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
            box-shadow: 0 4px 10px rgba(255,0,0,0.3);
        }
    </style>
</head>
<body>

    <header class="navbar">
        <div class="container nav-flex">
            <div class="nav-left">
                <i class="fas fa-bars mobile-menu-btn" onclick="app.toggleMenu()"></i>
                
                <div class="logo-area" onclick="app.loadCategory('phim-moi-cap-nhat', 'Phim Mới Cập Nhật')">
                    <div class="logo">
                        <img src="https://i.ibb.co/fdXjtqst/IMG-4464.png" alt="Logo" id="main-logo">
                    </div>
                </div>
                
                <nav class="nav-menu" id="navMenu">
                    <div class="nav-item">
                        <a href="javascript:void(0)" onclick="app.loadCategory('phim-le', 'Phim Lẻ')">PHIM LẺ</a>
                    </div>
                    <div class="nav-item">
                        <a href="javascript:void(0)" onclick="app.loadCategory('phim-bo', 'Phim Bộ')">PHIM BỘ</a>
                    </div>
                    <div class="nav-item">
                        <a href="javascript:void(0)" onclick="app.loadCategory('hoat-hinh', 'Hoạt Hình')">HOẠT HÌNH</a>
                    </div>
					<div class="nav-item">
                        <a href="javascript:void(0)" onclick="app.loadCategory('phim-long-tieng', 'PHIM LỒNG TIẾNG')">PHIM LỒNG TIẾNG</a>
                    </div>
                    
					<div class="nav-item has-dropdown">
                        <a href="javascript:void(0)">QUỐC GIA <i class="fas fa-chevron-down" style="font-size: 10px;"></i></a>
                        <div class="dropdown-menu" style="min-width: 300px; grid-template-columns: repeat(2, 1fr);">
                            <a href="javascript:void(0)" onclick="app.loadCategory('quoc-gia/trung-quoc', 'Phim Trung Quốc')">Trung Quốc</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('quoc-gia/han-quoc', 'Phim Hàn Quốc')">Hàn Quốc</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('quoc-gia/nhat-ban', 'Phim Nhật Bản')">Nhật Bản</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('quoc-gia/viet-nam', 'Phim Việt Nam')">Việt Nam</a>
                        </div>
                    </div>
					
                    <div class="nav-item has-dropdown">
                        <a href="javascript:void(0)">THỂ LOẠI <i class="fas fa-chevron-down" style="font-size: 10px;"></i></a>
                        <div class="dropdown-menu">
                            <a href="javascript:void(0)" onclick="app.loadCategory('the-loai/short-drama', 'Short Drama')">Short Drama</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('the-loai/hai-huoc', 'Phim Hài Hước')">Hài Hước</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('the-loai/hinh-su', 'Phim Hình Sự')">Hình Sự</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('the-loai/vo-thuat', 'Phim Võ Thuật')">Võ Thuật</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('the-loai/khoa-hoc', 'Phim Khoa Học')">Khoa Học</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('the-loai/than-thoai', 'Phim Thần Thoại')">Thần Thoại</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('the-loai/chinh-kich', 'Phim Chính kịch')">Chính kịch</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('the-loai/kinh-dien', 'Phim Kinh Điển')">Kinh Điển</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('the-loai/hanh-dong', 'Phim Hành Động')">Hành Động</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('the-loai/co-trang', 'Phim Cổ Trang')">Cổ Trang</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('the-loai/chien-tranh', 'Phim Chiến Tranh')">Chiến Tranh</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('the-loai/kinh-di', 'Phim Kinh Dị')">Kinh Dị</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('the-loai/vien-tuong', 'Phim Viễn Tưởng')">Viễn Tưởng</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('the-loai/tai-lieu', 'Phim Tài Liệu')">Tài Liệu</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('the-loai/bi-an', 'Phim Bí Ẩn')">Bí Ẩn</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('the-loai/tinh-cam', 'Phim Tình Cảm')">Tình Cảm</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('the-loai/tam-ly', 'Phim Tâm Lý')">Tâm Lý</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('the-loai/the-thao', 'Phim Thể Thao')">Thể Thao</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('the-loai/phieu-luu', 'Phim Phiêu Lưu')">Phiêu Lưu</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('the-loai/am-nhac', 'Phim Âm Nhạc')">Âm Nhạc</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('the-loai/gia-dinh', 'Phim Gia Đình')">Gia Đình</a>
                            <a href="javascript:void(0)" onclick="app.loadCategory('the-loai/hoc-duong', 'Phim Học Đường')">Học Đường</a>
                        </div>
                    </div>
                </nav>
            </div>

            <div class="nav-right">
                <i class="fas fa-search mobile-search-btn" onclick="app.toggleSearch()"></i>
                
                <div class="search-wrapper" id="searchWrapper">
                    <div class="search-input-group">
                        <input type="text" id="searchInput" placeholder="Tìm kiếm phim..." autocomplete="off">
                        <button onclick="app.search()"><i class="fas fa-search"></i></button>
                    </div>
                    <div id="search-results-dropdown" class="search-dropdown"></div>
                </div>

                <div class="auth-area" id="auth-area">
                    <button class="btn-login-nav" onclick="app.openAuthModal()">Đăng nhập</button>
                </div>
            </div>
        </div>
    </header>

    <main id="home-view" class="view">
        
        <div class="featured-hero" id="hero-section">
            <div class="hero-bg" id="hero-bg-img"></div>
            <div class="hero-gradient-overlay"></div>
            <div class="container hero-content-wrapper">
                <div class="hero-box">
                    <span class="trending-label" id="hero-status"><i class="fas fa-fire"></i> Đang tải...</span>
                    <h1 id="hero-title">Xin chờ trong giây lát...</h1>
                    <div class="hero-meta">
                        <span class="meta-item" id="hero-year">2026</span>
                        <span class="meta-item" id="hero-quality">HD</span>
                        <span class="meta-item" id="hero-lang">Vietsub</span>
                    </div>
                    <p id="hero-desc">Hàng ngàn bộ phim bom tấn được cập nhật liên tục mỗi ngày với chất lượng HD cực đỉnh. Trải nghiệm không gian giải trí hoàn hảo ngay tại nhà.</p>
                    <div class="hero-actions-fpt">
                        <button class="btn-play-fpt" id="hero-play-btn"><i class="fas fa-play"></i> XEM NGAY</button>
                        <button class="btn-detail-fpt" id="hero-detail-btn"><i class="fas fa-info-circle"></i> CHI TIẾT</button>
                    </div>
                </div>
            </div>
            <div class="hero-nav-buttons">
                <button class="hero-nav-btn prev" onclick="app.prevHero()"><i class="fas fa-chevron-left"></i></button>
                <button class="hero-nav-btn next" onclick="app.nextHero()"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>

        <div class="container main-layout">
            
            <div class="main-content">
                <div id="history-section" style="display: none; margin-bottom: 40px;">
                    <div class="section-header">
                        <h2><i class="fas fa-history" style="color: var(--accent)"></i> Tiếp Tục Xem</h2>
                        <div class="line"></div>
                    </div>
                    <div id="history-grid" class="horizontal-scroll-grid"></div> 
                </div>

                <div class="section-header">
                    <h2 id="page-title">Phim Mới Cập Nhật</h2>
                    <div class="line"></div>
                </div>
                <div id="movie-grid" class="movie-grid"></div>
                <div class="pagination-area">
                    <button class="btn-load" onclick="app.loadMore()">Xem Thêm</button>
                </div>
            </div>

            <aside class="sidebar">
                <div class="section-header">
                    <h2><i class="fas fa-chart-line" style="color: var(--accent)"></i> Top Xem Nhiều</h2>
                    <div class="line"></div>
                </div>
                <div class="top-movies-list" id="top-movies-list">
                </div>
            </aside>

        </div>
    </main>

    <main id="detail-view" class="view" style="display:none;">
        <div class="blur-bg" id="detail-blur-bg"></div>
        <div class="container">
            <button class="back-link" onclick="app.showHome()"><i class="fas fa-chevron-left"></i> Quay Lại</button>
            
            <div class="movie-detail-flex">
                <div class="poster-box">
                    <img id="m-poster" src="" alt="Poster">
                </div>
                <div class="info-box">
                    <h1 id="m-name">Tên Phim</h1>
                    <div class="tags">
                        <span id="m-year"></span>
                        <span id="m-quality">HD</span>
                        <span id="m-lang">Vietsub</span>
                        <button id="btn-trailer" class="tag-btn" onclick="app.openTrailer()"><i class="fas fa-video"></i> Xem Trailer</button>
                    </div>
                    <div class="synopsis">
                        <h3>Nội Dung Phim:</h3>
                        <p id="m-summary"></p>
                    </div>
					
					<div class="keywords-section" style="margin-top: 30px;">
                        <h3 style="font-size: 16px; margin-bottom: 15px; border-left: 3px solid var(--accent); padding-left: 10px; color: var(--accent);"><i class="fas fa-hashtag"></i> Từ Khóa Phim:</h3>
                        <div id="m-keywords" style="display: flex; flex-wrap: wrap;"></div>
                    </div>

                    <div class="actors-section">
                        <h3>Diễn Viên:</h3>
                        <div id="m-actors" class="actors-grid"></div>
                    </div>
                </div>
            </div>

            <div class="player-section">
                <div class="video-holder">
                    <iframe id="video-iframe" src="" frameborder="0" allowfullscreen></iframe>
                </div>
            </div>

            <div class="episodes-section">
                <div style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px;">
                    <h3 style="margin-bottom: 0;"><i class="fas fa-list"></i> Danh Sách Tập:</h3>
                    <div id="server-list" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
                </div>
                <div id="episode-list" class="episode-flex"></div>
            </div>

            <div class="comments-section" style="margin-top: 50px;">
                <div class="section-header">
                    <h2><i class="fas fa-comments" style="color: var(--accent)"></i> Thảo Luận Phim</h2>
                    <div class="line"></div>
                </div>
                <div class="custom-comment-wrapper">
                    <div class="comment-input-area">
                        <img id="current-user-avatar-movie" src="" style="display:none;">
                        <textarea id="comment-text-movie" placeholder="Bạn nghĩ sao về bộ phim này? Đăng nhập để bình luận ngay..."></textarea>
                        <button onclick="app.postComment('movie')"><i class="fas fa-paper-plane"></i> Gửi</button>
                    </div>
                    <div class="comments-list" id="comments-list-movie">
                    </div>
                </div>
            </div>

            <div class="similar-section" style="margin-top: 50px;">
                <div class="section-header">
                    <h2><i class="fas fa-film" style="color: var(--accent)"></i> Có Thể Bạn Sẽ Thích</h2>
                    <div class="line"></div>
                </div>
                <div id="similar-grid" class="horizontal-scroll-grid"></div>
            </div>
        </div>
    </main>
    
    <main id="review-view" class="view" style="display:none; padding: 40px 0; min-height: 80vh;">
        <div class="container">
            <div class="section-header" style="margin-top: 20px;">
                <h2 style="font-size: 28px;"><i class="fas fa-pen-nib" style="color: var(--accent)"></i> Góc Review & Cảm Nhận Phim</h2>
                <div class="line"></div>
            </div>
            
            <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); padding: 30px; border-radius: 16px; margin-bottom: 40px;">
                <h3 style="color: var(--accent); margin-bottom: 15px; font-size: 20px;">Chia sẻ siêu phẩm bạn vừa xem!</h3>
                <p style="color: #ccc; line-height: 1.8; font-size: 15px;">Bạn vừa xem một bộ phim quá đỉnh và muốn giới thiệu cho mọi người? Hay bạn có những góc nhìn phân tích thú vị về một tác phẩm điện ảnh kinh điển? <br><br>Hãy để lại bình luận phía dưới nhé. Đừng quên <b>gắn thêm link phim</b> để mọi người cùng xem!</p>
            </div>

            <div class="custom-comment-wrapper">
                <div class="comment-input-area">
                    <img id="current-user-avatar-review" src="" style="display:none;">
                    <textarea id="comment-text-review" placeholder="Viết bài review của bạn..."></textarea>
                    <button onclick="app.postComment('review')"><i class="fas fa-paper-plane"></i> Đăng Bài</button>
                </div>
                <div class="comments-list" id="comments-list-review">
                </div>
            </div>
        </div>
    </main>

    <div id="auth-modal" class="modal-overlay" style="display: none;" onclick="app.closeAuthModal()">
        <div class="auth-modal-content" onclick="event.stopPropagation()">
            <button class="close-modal-btn" onclick="app.closeAuthModal()"><i class="fas fa-times"></i></button>
            <div class="auth-logo">
                <img src="https://media.discordapp.net/attachments/1418490592320819235/1476650043426476052/IMG_4464.png" alt="Logo" style="height: 50px; margin-bottom: 20px; filter: drop-shadow(0 0 5px rgba(255, 77, 77, 0.3));">
            </div>
            <h2 id="auth-title">Đăng Nhập</h2>
            <p>Tạo một cái tên để bắt đầu chém gió cùng mọi người trong phần bình luận nhé!</p>
            <div class="auth-form">
                <input type="text" id="auth-username" placeholder="Nhập tên của bạn để hiển thị...">
                <button class="btn-auth-submit" onclick="app.login()">Tham gia ngay</button>
            </div>
        </div>
    </div>

    <div id="trailer-modal" class="modal-overlay" style="display: none;" onclick="app.closeTrailer()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="close-modal" onclick="app.closeTrailer()"><i class="fas fa-times"></i></button>
            <iframe id="trailer-iframe" src="" frameborder="0" allowfullscreen></iframe>
        </div>
    </div>
    
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <div class="logo">
                        <img src="https://i.ibb.co/spg2yYp2/IMG-4361.gif" alt="Logo" id="main-logo" style="height: 80px; filter: drop-shadow(0 0 5px rgba(255, 77, 77, 0.3));">
						<img src="https://i.ibb.co/spg2yYp2/IMG-4361.gif" alt="Logo" id="main-logo" style="height: 80px; filter: drop-shadow(0 0 5px rgba(255, 77, 77, 0.3));">
						<img src="https://i.ibb.co/spg2yYp2/IMG-4361.gif" alt="Logo" id="main-logo" style="height: 80px; filter: drop-shadow(0 0 5px rgba(255, 77, 77, 0.3));">
                    </div>
                    <p>Trải nghiệm xem phim trực tuyến chất lượng cao với hàng ngàn bộ phim bom tấn được cập nhật liên tục mỗi ngày. Chúc các bạn xem phim vui vẻ !!!</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-discord"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
                <div class="footer-links">
                    <h3>Thể Loại</h3>
                    <ul>
                        <li><a href="javascript:void(0)" onclick="app.loadCategory('phim-le', 'Phim Lẻ')">Phim Lẻ</a></li>
                        <li><a href="javascript:void(0)" onclick="app.loadCategory('phim-bo', 'Phim Bộ')">Phim Bộ</a></li>
                        <li><a href="javascript:void(0)" onclick="app.loadCategory('hoat-hinh', 'Hoạt Hình')">Hoạt Hình</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h3>Hỗ Trợ</h3>
                    <ul>
                        <li><a href="#">Hỏi đáp</a></li>
                        <li><a href="#">Chính sách bảo mật</a></li>
                        <li><a href="#">Giới thiệu</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 Haruno. Powered by ???</p>
            </div>
        </div>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // BẠN SẼ THAY 1 LOẠT CHỮ BÊN DƯỚI BẰNG CODE CỦA BẠN (XEM HƯỚNG DẪN Ở BƯỚC 2)
        const firebaseConfig = {
            apiKey: "AIzaSyBGmYG39lizLSntgmF9UStxupVGefLvfrM",
            authDomain: "web-phim-haruno.firebaseapp.com",
            databaseURL: "https://web-phim-haruno-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "web-phim-haruno",
            storageBucket: "web-phim-haruno.firebasestorage.app",
            messagingSenderId: "458970016952",
            appId: "1:458970016952:web:c4f0627f3aee01c80b984d"
        };

        // Khởi tạo máy chủ bình luận
        let db = null;
        try {
            if (firebaseConfig.apiKey !== "") {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
            }
        } catch(e) { console.log("Lỗi Firebase:", e); }

        const API_URL = 'https://ophim1.com';
        const IMG_DOMAIN = 'https://img.ophim.live/uploads/movies/';

        const app = {
            currentPage: 1,
            currentType: 'phim-moi-cap-nhat',
            isSearch: false,
            currentTrailer: '',
			currentMovieSlug: '',

            checkAuth() {
                const user = localStorage.getItem('haruno_user');
                const authArea = document.getElementById('auth-area');
                if (user) {
                    authArea.innerHTML = `
                        <div class="user-profile" onclick="app.logout()">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(user)}" alt="Avatar" class="user-avatar">
                            <span class="user-name">${user}</span>
                        </div>
                    `;
                } else {
                    authArea.innerHTML = `<button class="btn-login-nav" onclick="app.openAuthModal()">Đăng nhập</button>`;
                }
                
                if(this.currentMovieSlug) this.loadComments(this.currentMovieSlug, 'movie');
            },
            openAuthModal() { document.getElementById('auth-modal').style.display = 'flex'; },
            closeAuthModal() { document.getElementById('auth-modal').style.display = 'none'; },
            login() {
                const name = document.getElementById('auth-username').value.trim();
                if(name) {
                    localStorage.setItem('haruno_user', name);
                    this.checkAuth();
                    this.closeAuthModal();
                } else { alert("Vui lòng nhập tên của bạn!"); }
            },
            logout() {
                if(confirm("Bạn muốn đăng xuất khỏi tài khoản này?")) {
                    localStorage.removeItem('haruno_user');
                    this.checkAuth();
                }
            },

            // === HỆ THỐNG BÌNH LUẬN TRỰC TUYẾN FIREBASE ===
            loadComments(slug, type) {
                const listId = type === 'movie' ? 'comments-list-movie' : 'comments-list-review';
                const list = document.getElementById(listId);
                if (!list) return;

                const user = localStorage.getItem('haruno_user');
                const avatarId = type === 'movie' ? 'current-user-avatar-movie' : 'current-user-avatar-review';
                const avatarImg = document.getElementById(avatarId);
                if(avatarImg) {
                    if(user) { avatarImg.src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(user)}`; avatarImg.style.display = 'block'; }
                    else { avatarImg.style.display = 'none'; }
                }

                if (!db) {
                    list.innerHTML = '<p style="color:#ff4d4d; text-align:center; padding: 20px;">Vui lòng kết nối Cơ Sở Dữ Liệu (Firebase) để kích hoạt bình luận Online!</p>';
                    return;
                }

                list.innerHTML = '<p style="color:#888; text-align:center; padding: 20px;">Đang tải bình luận...</p>';

                // Kết nối Realtime: Tự động tải lại khi có người khác vừa chat
                db.ref('comments/' + slug).on('value', (snapshot) => {
                    const data = snapshot.val();
                    let comments = [];
                    if (data) {
                        comments = Object.values(data).reverse(); // Đảo ngược để bình luận mới nhất nổi lên đầu
                    }
                    
                    if(comments.length === 0) {
                        comments = [{ name: 'AdminFF', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Admin', text: 'Chưa có bình luận nào. Hãy là người đầu tiên nhé!', date: 'Hệ thống' }];
                    }
                    
                    list.innerHTML = comments.map(c => `
                        <div class="comment-item">
                            <div class="comment-avatar"><img src="${c.avatar}"></div>
                            <div class="comment-content">
                                <div class="comment-author">${c.name} <span class="comment-date">${c.date}</span></div>
                                <div class="comment-text">${c.text}</div>
                            </div>
                        </div>
                    `).join('');
                });
            },

            postComment(type) {
                const user = localStorage.getItem('haruno_user');
                if(!user) { this.openAuthModal(); return; } 
               
                const inputId = type === 'movie' ? 'comment-text-movie' : 'comment-text-review';
                const text = document.getElementById(inputId).value.trim();
                if(!text) return;

                if (!db) {
                    alert("Bạn chưa cấu hình Firebase. Bình luận không thể gửi lên mạng!");
                    return;
                }

                const slug = this.currentMovieSlug;
                const now = new Date();
                const timeString = now.getHours() + ':' + (now.getMinutes()<10?'0':'') + now.getMinutes() + ' - ' + now.getDate() + '/' + (now.getMonth()+1);
                
                const newComment = { 
                    name: user, 
                    avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(user)}`, 
                    text: text, 
                    date: timeString 
                };
                
                // Bắn bình luận lên Máy chủ Đám mây
                db.ref('comments/' + slug).push(newComment);
                document.getElementById(inputId).value = '';
            },

            toggleSearch() {
                const searchWrap = document.getElementById('searchWrapper');
                const menuWrap = document.getElementById('navMenu');
                if (menuWrap) menuWrap.classList.remove('active'); 
                
                searchWrap.classList.toggle('active');
                if (searchWrap.classList.contains('active')) {
                    document.getElementById('searchInput').focus();
                }
            },

            toggleMenu() {
                const menuWrap = document.getElementById('navMenu');
                const searchWrap = document.getElementById('searchWrapper');
                if (searchWrap) searchWrap.classList.remove('active'); 
                
                menuWrap.classList.toggle('active');
            },

            getImage(movie) {
                let path = movie.thumb_url || movie.poster_url;
                if (!path) return 'https://via.placeholder.com/300x450?text=No+Image';
                return path.startsWith('http') ? path : IMG_DOMAIN + path;
            },
            
            showSkeleton(elementId, count = 12, isHorizontal = false) {
                const grid = document.getElementById(elementId);
                if (!grid) return;
                const skeletonHTML = Array(count).fill(`
                    <div class="movie-card ${isHorizontal ? 'scroll-item' : ''}" style="border:none; background:transparent;">
                        <div class="skeleton skel-img"></div>
                        <div class="skeleton skel-text" style="width: 80%; margin-top: 10px;"></div>
                        <div class="skeleton skel-text" style="width: 50%;"></div>
                    </div>
                `).join('');
                grid.innerHTML = skeletonHTML;
            },

            createMovieCard(m, isHorizontal = false) {
                const year = m.year || '2026';
                const country = m.country && m.country.length > 0 ? m.country[0].name : 'N/A';
                const format = `${m.quality || 'HD'} ${m.lang || ''}`;
                const status = m.episode_current || 'Đang cập nhật';
                const genres = m.category ? m.category.map(c => c.name).slice(0, 2).join(', ') : '';

                const card = document.createElement('div');
                card.className = `movie-card ${isHorizontal ? 'scroll-item' : ''}`;
                card.innerHTML = `
                    <div class="thumb">
                        <img src="${this.getImage(m)}" loading="lazy">
                        <div class="badge">${status}</div>
                        <div class="hover-info">
                            <div class="hover-content">
                                <h4>${m.name}</h4>
                                <div class="h-details-grid">
                                    <div class="h-item" title="${country}"><span>Quốc gia:</span> ${country}</div>
                                    <div class="h-item"><span>Định dạng:</span> ${format}</div>
                                    <div class="h-item"><span>Năm:</span> ${year}</div>
                                    <div class="h-item" title="${status}"><span>Tình trạng:</span> ${status}</div>
                                </div>
                                <div class="h-genre-tag">${genres}</div>
                                <div class="h-btn"><i class="fas fa-play"></i> XEM NGAY</div>
                            </div>
                        </div>
                        <div class="play-btn"><i class="fas fa-play"></i></div>
                    </div>
                    <div class="meta"><h4>${m.name}</h4></div>
                `;
                card.onclick = () => this.showMovie(m.slug);
                return card;
            },

            async renderMovies(append = false) {
                let url;
                if (this.isSearch) {
                    url = `${API_URL}/v1/api/tim-kiem?keyword=${encodeURIComponent(this.currentType)}&page=${this.currentPage}`;
                } else if (this.currentType === 'phim-moi-cap-nhat') {
                    url = `${API_URL}/danh-sach/phim-moi-cap-nhat?page=${this.currentPage}`;
                } else {
                    const path = this.currentType.includes('/') ? this.currentType : `danh-sach/${this.currentType}`;
                    url = `${API_URL}/v1/api/${path}?page=${this.currentPage}`;
                }

                if(!append) this.showSkeleton('movie-grid', 12);

                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    const items = data.items || (data.data && data.data.items) || [];
                    const grid = document.getElementById('movie-grid');
                    if (!append) grid.innerHTML = '';

                    if (items.length > 0) {
                        items.forEach(m => grid.appendChild(this.createMovieCard(m)));
                    } else if (!append) {
                        grid.innerHTML = '<p style="text-align:center; width:100%; padding: 40px;">Không tìm thấy phim nào trong danh mục này.</p>';
                    }
                } catch (e) { 
                    console.log("Lỗi:", e); 
                    if (!append) document.getElementById('movie-grid').innerHTML = '<p style="text-align:center; width:100%;">Lỗi kết nối máy chủ.</p>';
                }
            },

            async showMovie(slug, savedEpLink = null) {
                this.currentMovieSlug = slug; 
                document.getElementById('search-results-dropdown').style.display = 'none';
                window.scrollTo(0, 0);
                this.showHome(false); 
                
                document.getElementById('m-name').innerText = "Đang tải...";
                document.getElementById('m-summary').innerHTML = "";
                
                const epBox = document.getElementById('episode-list');
                const serverBox = document.getElementById('server-list');
                epBox.innerHTML = '';
                if(serverBox) serverBox.innerHTML = '';

                this.showSkeleton('similar-grid', 6, true);

                try {
                    const res = await fetch(`${API_URL}/phim/${slug}`);
                    const data = await res.json();
                    const m = data.movie;
                    const finalImg = this.getImage(m);
                    
                    document.getElementById('m-name').innerText = m.name;
                    document.getElementById('m-poster').src = finalImg;
                    document.getElementById('detail-blur-bg').style.backgroundImage = `url(${finalImg})`;
                    document.getElementById('m-year').innerText = m.year || 'Đang cập nhật';
                    document.getElementById('m-quality').innerText = m.quality || 'HD';
                    document.getElementById('m-lang').innerText = m.lang || 'Vietsub';
                    document.getElementById('m-summary').innerHTML = m.content;

                    this.currentTrailer = m.trailer_url || '';
                    document.getElementById('btn-trailer').style.display = this.currentTrailer ? 'inline-block' : 'none';

                    const keywordsBox = document.getElementById('m-keywords');
                    let keywordHtml = '';

                    if(m.name) keywordHtml += `<span class="keyword-tag" onclick="app.search('${m.name.replace(/'/g, "\\'")}')">#${m.name.replace(/\s+/g, '')}</span>`;
                    if(m.origin_name) keywordHtml += `<span class="keyword-tag" onclick="app.search('${m.origin_name.replace(/'/g, "\\'")}')">#${m.origin_name.replace(/\s+/g, '')}</span>`;
                    if(m.year) keywordHtml += `<span class="keyword-tag" onclick="app.search('${m.year}')">#PhimNăm${m.year}</span>`;

                    if (m.category && m.category.length > 0) {
                        m.category.forEach(c => {
                            keywordHtml += `<span class="keyword-tag" onclick="app.loadCategory('the-loai/${c.slug}', '${c.name.replace(/'/g, "\\'")}')">#${c.name.replace(/\s+/g, '')}</span>`;
                        });
                    }
                    if (m.country && m.country.length > 0) {
                        m.country.forEach(c => {
                            keywordHtml += `<span class="keyword-tag" onclick="app.loadCategory('quoc-gia/${c.slug}', '${c.name.replace(/'/g, "\\'")}')">#${c.name.replace(/\s+/g, '')}</span>`;
                        });
                    }
                    keywordsBox.innerHTML = keywordHtml;

                    const actorsBox = document.getElementById('m-actors');
                    actorsBox.innerHTML = '';
                    if (m.actor && m.actor[0]) {
                        m.actor.forEach(a => {
                            actorsBox.innerHTML += `<div class="actor-item"><div class="actor-img"><i class="fas fa-user"></i></div><p>${a}</p></div>`;
                        });
                    }

                    if (data.episodes && data.episodes.length > 0) {
                        let initialServerIdx = 0;
                        
                        if (savedEpLink) {
                            const foundIdx = data.episodes.findIndex(srv => srv.server_data.some(ep => ep.link_embed === savedEpLink));
                            if (foundIdx !== -1) initialServerIdx = foundIdx;
                        }

                        data.episodes.forEach((serverObj, serverIdx) => {
                            const srvBtn = document.createElement('button');
                            srvBtn.className = 'server-btn';
                            srvBtn.innerText = serverObj.server_name || `Server ${serverIdx + 1}`;
                            
                            srvBtn.onclick = () => {
                                document.querySelectorAll('.server-btn').forEach(b => b.classList.remove('active'));
                                srvBtn.classList.add('active');
                                
                                epBox.innerHTML = '';
                                serverObj.server_data.forEach((ep, idx) => {
                                    const btn = document.createElement('button');
                                    btn.className = 'ep-btn';
                                    btn.innerText = ep.name;
                                    btn.onclick = () => {
                                        document.getElementById('video-iframe').src = ep.link_embed;
                                        document.querySelectorAll('.ep-btn').forEach(b => b.classList.remove('active'));
                                        btn.classList.add('active');
                                        this.saveHistory(m, ep.name, ep.link_embed);
                                    };
                                    epBox.appendChild(btn);
                                    
                                    if(savedEpLink && ep.link_embed === savedEpLink) {
                                        btn.click();
                                        savedEpLink = null; 
                                    } else if (!savedEpLink && idx === 0) {
                                        btn.click();
                                    }
                                });
                            };
                            
                            if (serverBox) serverBox.appendChild(srvBtn);
                            
                            if (serverIdx === initialServerIdx) {
                                srvBtn.click();
                            }
                        });
                    }

                    this.loadComments(slug, 'movie');

                    if(m.category && m.category[0]) {
                        const catSlug = m.category[0].slug;
                        const simRes = await fetch(`${API_URL}/v1/api/the-loai/${catSlug}?limit=10`);
                        const simData = await simRes.json();
                        const simItems = simData.data.items.filter(i => i.slug !== m.slug).slice(0,8);
                        const simGrid = document.getElementById('similar-grid');
                        simGrid.innerHTML = '';
                        simItems.forEach(sm => simGrid.appendChild(this.createMovieCard(sm, true)));
                    }

                } catch (e) { alert("Lỗi khi tải phim!"); }
            },

            showReview() {
                this.currentMovieSlug = 'goc-review';
                window.scrollTo(0, 0);
                document.getElementById('home-view').style.display = 'none';
                document.getElementById('detail-view').style.display = 'none';
                document.getElementById('review-view').style.display = 'block';
                document.getElementById('video-iframe').src = '';
                
                const menuWrap = document.getElementById('navMenu');
                if (menuWrap) menuWrap.classList.remove('active');

                this.loadComments('goc-review', 'review');
            },

            saveHistory(movie, epName, epLink) {
                let history = JSON.parse(localStorage.getItem('haruno_history') || '[]');
                history = history.filter(h => h.slug !== movie.slug);
                history.unshift({ slug: movie.slug, name: movie.name, thumb: this.getImage(movie), epName: epName, epLink: epLink });
                if(history.length > 8) history.pop();
                localStorage.setItem('haruno_history', JSON.stringify(history));
            },

            renderHistory() {
                let history = JSON.parse(localStorage.getItem('haruno_history') || '[]');
                const section = document.getElementById('history-section');
                const grid = document.getElementById('history-grid');
                if(!history.length) { section.style.display = 'none'; return; }
                section.style.display = 'block';
                grid.innerHTML = history.map(h => `
                    <div class="movie-card scroll-item" onclick="app.showMovie('${h.slug}', '${h.epLink}')" style="border: 1px solid var(--accent);">
                        <div class="thumb">
                            <img src="${h.thumb}"><div class="badge" style="background:var(--accent);">Đang xem: Tập ${h.epName}</div>
                        </div>
                        <div class="meta"><h4>${h.name}</h4></div>
                    </div>
                `).join('');
            },

            openTrailer() {
                if(!this.currentTrailer) return;
                let embedUrl = this.currentTrailer.includes('watch?v=') ? this.currentTrailer.replace('watch?v=', 'embed/') : this.currentTrailer;
                document.getElementById('trailer-iframe').src = embedUrl;
                document.getElementById('trailer-modal').style.display = 'flex';
            },
            closeTrailer() {
                document.getElementById('trailer-iframe').src = "";
                document.getElementById('trailer-modal').style.display = 'none';
            },

            search(customKeyword) {
                let val = '';
                if (typeof customKeyword === 'string') {
                    val = customKeyword;
                } else {
                    val = document.getElementById('searchInput').value.trim();
                }

                if(val) {
                    this.isSearch = true; this.currentType = val; this.currentPage = 1;
                    document.getElementById('page-title').innerText = `Kết quả: ${val}`;
                    this.showHome(true);
                    this.renderMovies();
                    document.getElementById('searchWrapper').classList.remove('active');
                    document.getElementById('search-results-dropdown').style.display = 'none';
                    document.getElementById('searchInput').value = val;
                }
            },

            loadCategory(slug, title) {
                this.isSearch = false; this.currentType = slug; this.currentPage = 1;
                document.getElementById('page-title').innerText = title;
                this.showHome(true);
                window.scrollTo({ top: 0, behavior: 'smooth' });
                const menuWrap = document.getElementById('navMenu');
                if (menuWrap) menuWrap.classList.remove('active');
                this.renderMovies();
            },

            loadMore() { this.currentPage++; this.renderMovies(true); },

            showHome(isHome = true) {
                document.getElementById('review-view').style.display = 'none';
                document.getElementById('home-view').style.display = isHome ? 'block' : 'none';
                document.getElementById('detail-view').style.display = isHome ? 'none' : 'block';
                if(isHome) { document.getElementById('video-iframe').src = ''; this.renderHistory(); }
            },

            heroData: [], currentHeroIndex: 0, heroInterval: null,
            async initHero() {
                try {
                    const res = await fetch(`${API_URL}/danh-sach/phim-moi-cap-nhat?page=1`);
                    const data = await res.json();
                    const top5 = (data.items || (data.data && data.data.items) || []).slice(0, 5); 
                    const detailPromises = top5.map(m => fetch(`${API_URL}/phim/${m.slug}`).then(r => r.json()));
                    const detailData = await Promise.all(detailPromises);
                    this.heroData = detailData.map(d => d.movie);
                    if (this.heroData.length > 0) {
                        this.renderCurrentHero();
                        this.startHeroAutoPlay();
                    }
                } catch (e) { }
            },
            getHeroPoster(movie) {
                let path = movie.poster_url;
                if (!path) return 'https://via.placeholder.com/1200x600?text=No+Image';
                return path.startsWith('http') ? path : IMG_DOMAIN + path;
            },
            renderCurrentHero() {
                const m = this.heroData[this.currentHeroIndex];
                if (!m) return;
                document.getElementById('hero-bg-img').style.backgroundImage = `url('${this.getHeroPoster(m)}')`;
                document.getElementById('hero-title').innerText = m.name;
                document.getElementById('hero-desc').innerHTML = m.content ? m.content.replace(/<[^>]*>?/gm, '') : 'Không có thông tin mô tả.';
                document.getElementById('hero-status').innerHTML = `<i class="fas fa-fire"></i> ${m.episode_current || 'Hoàn tất'}`;
                document.getElementById('hero-year').innerText = m.year || '2026';
                document.getElementById('hero-quality').innerText = m.quality || 'HD';
                document.getElementById('hero-lang').innerText = m.lang || 'Vietsub';
                
                document.getElementById('hero-play-btn').onclick = () => this.showMovie(m.slug);
                document.getElementById('hero-detail-btn').onclick = () => this.showMovie(m.slug);

                const heroBox = document.querySelector('.hero-box');
                if (heroBox) { heroBox.style.animation = 'none'; heroBox.offsetHeight; heroBox.style.animation = null; }
            },
            nextHero() { this.currentHeroIndex = (this.currentHeroIndex + 1) % this.heroData.length; this.renderCurrentHero(); this.resetHeroTimer(); },
            prevHero() { this.currentHeroIndex = (this.currentHeroIndex - 1 + this.heroData.length) % this.heroData.length; this.renderCurrentHero(); this.resetHeroTimer(); },
            startHeroAutoPlay() { this.heroInterval = setInterval(() => { this.nextHero(); }, 5000); },
            resetHeroTimer() { clearInterval(this.heroInterval); this.startHeroAutoPlay(); },

            async initTopMovies() {
                try {
                    const res = await fetch(`${API_URL}/v1/api/danh-sach/phim-bo?page=1`);
                    const data = await res.json();
                    const top10 = (data.data.items || []).slice(0, 10);
                    const topList = document.getElementById('top-movies-list');
                    if (topList) {
                        topList.innerHTML = top10.map((m, index) => `
                            <div class="top-movie-item" onclick="app.showMovie('${m.slug}')">
                                <div class="top-rank">${index + 1}</div>
                                <img class="top-thumb" src="${this.getImage(m)}" alt="${m.name}">
                                <div class="top-info">
                                    <h4>${m.name}</h4>
                                    <p>${m.origin_name || ''}</p>
                                    <p>${m.year || '2026'} • ${m.quality || 'HD'}</p>
                                </div>
                            </div>
                        `).join('');
                    }
                } catch (e) { }
            }
        };

        const searchInput = document.getElementById('searchInput');
        const searchDropdown = document.getElementById('search-results-dropdown');

        searchInput.addEventListener('input', async (e) => {
            const keyword = e.target.value.trim();
            if (keyword.length < 2) { searchDropdown.style.display = 'none'; return; }
            try {
                const response = await fetch(`${API_URL}/v1/api/tim-kiem?keyword=${encodeURIComponent(keyword)}&limit=6`);
                const data = await response.json();
                const movies = data.data.items.slice(0, 6); 

                if (movies.length > 0) {
                    searchDropdown.innerHTML = movies.map(movie => `
                        <div class="search-item" onclick="app.showMovie('${movie.slug}')">
                            <img src="${app.getImage(movie)}" alt="${movie.name}">
                            <div class="search-item-info">
                                <div class="title">${movie.name}</div>
                                <div class="sub-title">${movie.origin_name} (${movie.year})</div>
                            </div>
                        </div>
                    `).join('');
                    searchDropdown.style.display = 'block';
                } else {
                    searchDropdown.innerHTML = '<div class="search-no-result">Không tìm thấy phim nào...</div>';
                    searchDropdown.style.display = 'block';
                }
            } catch (error) { }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-wrapper')) { searchDropdown.style.display = 'none'; }
        });

        app.checkAuth();
        app.initHero();
        app.initTopMovies(); 
        app.renderHistory(); 
        app.renderMovies();  
    </script>
</body>
</html>